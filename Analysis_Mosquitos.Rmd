---
title: "Analysis_Mosquitos"
output: html_document
date: "2023-12-06"
editor_options: 
  markdown: 
    wrap: 72
---

# Does precipitation and temperature play a role in West Nile Virus Cases in Maricopa County?

I analyzed monthly reported West Nile cases in Maricopa County to
observe if climate and precipitation are playing a role in why this
county has seen an uptick in cases from 2006-2021. I also analyzed if
rainfall rates had any relationship to the endemic Maricopa County
experienced in 2021.

Data:
<https://www.azdhs.gov/preparedness/epidemiology-disease-control/index.php#data-stats-past-years>

Tmp and rain:
<https://usafacts.org/issues/climate/state/arizona/county/maricopa-county/>

## Introduction

The West Nile virus was first reported in the United States in 1999 and
since then there as been an uptick of cases. It is now the most common
cause of mosquito-borne diseases in the United States. While some may
experience mild symptoms such as rashes, body aches, and vomiting. For
others the Wets Nile virus can cause severe central nervous system
damage and can result in death. Since its initial report, there have
been a total of 55,443 cases reported to the U.S. Centers for Disease
Control and Prevention (CDC)[^1]. The transmission of the virus begins
with birds infecting mosquitoes which then in turn infect humans. The
ideal temperature for mosquitoes to survive is 50-95째F (10-35째C) and the
*Goldilocks* temperature is 75째F (24째C) [^2]
[^3].
Precipitation also plays a role in mosquitoes reproduction as standing
water is their preferred breeding ground.

Climate change is exacerbating the infections as warmer temperatures
create more favorable conditions for breeding and expand their
geographic range. It is also affecting bird's migratory patterns, birds
are a host of the virus, and the change in their migratory pattern can
expand the range of mosquitoes[^4].

The area of interest for this project is Maricopa County, Arizona. It is
one of 6 counties in the United States that saw high rates of West Nile
virus cases during 2009-2018. West Nile virus is an endemic in Maricopa
County, since it was first detected in 2003 there have been 4 outbreaks.
Their largest outbreak was during 2021, a total of 1,487 human West Nile
Virus cases were identified; 956 (64.3%) patients had neuroinvasive
disease, and 101 (6.8%) died [^5].

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Import libraries
library(sf)
library(raster)
library(tidyverse)
library(readr)
library(gt)
library(tufte)
library(feasts)
library(tsibble)
library(lubridate)
library(janitor)
library(patchwork)
library(lmtest)
library(tseries)
library(spData)
library(ggspatial)
library(dplyr)
library(tseries)
library(vars)
library(ggthemes)
```

```{r, echo=TRUE, dev='png'}
# code chunk of Maricopa County in Arizona for geographical context

maricopa <- read_sf("data/tl_2022_us_county") %>% 
  clean_names() %>% 
  filter(countyns == "00037026") 

plot(maricopa)

us_states

arizona <- us_states %>%
  filter(NAME %in% c('Arizona')) %>%
  st_transform(crs = st_crs(maricopa))

ggplot() +
  geom_sf(data = arizona, fill = "white", linewidth = 0.5, color = "black") +
  geom_sf(data = maricopa, fill = "#863195") +
   annotation_scale(location = 'bl', width = 0.1) +
  annotation_north_arrow(location = 'tl',height = unit(.8, "cm"),
  width = unit(.8, "cm"), style = north_arrow_fancy_orienteering()) + 
  geom_sf_text(data = arizona, label = "Arizona", nudge_y = 0.2) +
  theme_map()
  
```


[^1]: Climate change indicators: West Nile virus US EPA. (n.d.).
<https://www.epa.gov/climate-indicators/climate-change-indicators-west-nile-virus>

[^2]: Bailey, M. (2022, March 29). *Altered by climate change, the U.S.
could become ideal for West Nile to thrive*. PBS.
<https://www.pbs.org/newshour/health/altered-by-climate-change-the-u-s-could-become-ideal-for-west-nile-to-thrive#:~:text=For%20the%20three%20species%20of,the%20course%20of%20one%20day.>

[^3]:Mosquito Days Climate Central. (2020, July 29).
<https://www.climatecentral.org/climate-matters/more-mosquito-days>

[^4]:Centers for Disease Control and Prevention. (n.d.). Migratory birds and spread of West Nile virus in the Western Hemisphere - volume 6, number 4-August 2000 - emerging infectious diseases journal - CDC. Centers for Disease Control and Prevention. https://wwwnc.cdc.gov/eid/article/6/4/00-0401_article#:~:text=Migratory%20birds%20have%20long%20been%20suspected%20as%20the%20principal%20introductory,of%20migratory%20birds%20(and%20mosquitoes   

[^5]: Kretschmer, M., Ruberto, I., Townsend, J., Zabel, K., & Will, J.
(2023, April 28). Unprecedented outbreak of West Nile virus --- Maricopa
County, Arizona, 2021.
<https://www.cdc.gov/mmwr/volumes/72/wr/pdfs/mm7217a1-H.pdf>



```{r, include=FALSE}
# Import data
# Cases reported
west_nile <- read.csv("data/west_nile_monthly.csv")

# Monthly rainfall
monthly_rainfall <- read_csv("data/monthly_rainfall.csv") %>% clean_names()

# Monthly temperature
monthly_temp <- read_csv("data/monthly_temp.csv") %>%  clean_names()
```

## Time series decomposition
```{r, echo=FALSE}
# Prepping datasets
west_nile <- west_nile %>% 
  filter(Measure == "Records with zeros along MONTHREP")
# Setting column names to be factors
west_nile[, 4:15] <- lapply(west_nile[, 4:15], as.factor)

column_names <- names(west_nile)[4:15]


# Pivot longer
west_nile <- west_nile %>%
  pivot_longer(cols = all_of(column_names),
               names_to = "month",
               values_to = "cases")

# Combine my year and months
west_nile$date <- paste(west_nile$Year, west_nile$month, sep="_")

## Prepare time series including 2021 
west_nile_2021 <- west_nile %>% 
  mutate(date1 = ym(date),
         date = yearmonth(date),
         cases = as.numeric(as.character(cases))) %>% 
  select(c(date,cases))


# Time series excluding 2021
west_nile_2020 <- west_nile %>% 
  mutate(date1 =lubridate::ym(date),
         date = yearmonth(date),
         cases = as.numeric(as.character(cases))) %>% 
  filter(date1 < "2021-01-01") %>% 
  select(c(date,cases,date1))



ggplot(west_nile_2021, aes(x = date, y = cases)) +
  geom_line(color = "blue") + geom_smooth() 
  scale_x_date(breaks = scales::pretty_breaks(n=10),date_labels = "%b-%Y") 


ggplot(west_nile_2020, aes(x = date1, y = cases)) +
  geom_line(color = "blue") + geom_smooth() +
  scale_x_date(breaks = scales::pretty_breaks(n=10),date_labels = "%b-%Y") +
  labs(x = "Date")

```


```{r}
# Decomposition Development

# Set date in correct format and change cases into numeric values
west_nile_2020 <- west_nile_2020 %>% 
  mutate(date = yearmonth(date),
         cases = as.numeric(as.character(cases))) 


# Select the columns we are interested in
west_nile_2020 <- west_nile_2020 %>% select(c(date,cases)) 

# Decomposition 
as_tsibble(west_nile_2020) %>% 
  model(classical_decomposition(cases, type = "additive")) %>%
  components() %>%
  autoplot() 

```

```{r}
# Decomposition including 2021 data 


# Set date in correct format and change cases into numeric values
west_nile_2021 <- west_nile_2021 %>% 
  mutate(date = yearmonth(date),
         cases = as.numeric(as.character(cases))) 


# Select the columns we are interested in
west_nile_2021 <- west_nile_2021 %>% select(c(date,cases)) 

# Decomposition 
as_tsibble(west_nile_2021) %>% 
  model(classical_decomposition(cases, type = "additive")) %>%
  components() %>%
  autoplot() 



```

```{r}
# Monthly rainfall data

monthly_rainfall <- monthly_rainfall  %>% 
  select(time_0, data_0) %>% 
  rename("date" = time_0,
          "rainfall_in" = data_0) %>% 
  mutate(date = ym(date)) %>% filter(date >= "2006-01-01" & date <= "2021-12-1")

ggplot(monthly_rainfall, aes(x = date, y = rainfall_in)) +
  geom_line(color = "red") +
  scale_x_date(breaks = scales::pretty_breaks(n=10),date_labels = "%b-%Y")


## create a model with mosquitos -- temp and rainfall
## plot rainfall and temperature 
## plot rainfall and mosquitos



```

```{r}
## Monthly Temperature

monthly_temp <- monthly_temp %>% 
  select(time_0, data_0) %>% 
  rename("date" = time_0,
         "temp_f" = data_0) %>% 
  mutate(date = ym(date)) %>% 
  filter(date >= "2006-01-01" & date < "2021-12-1")
  
  
```

```{r}
### Join data
mosquitos_data <- west_nile_2020 %>% left_join(.,
                                               monthly_rainfall, by = "date") %>%
  left_join(.,monthly_temp, by = "date") %>% mutate(date = yearmonth(date),
                                                    temp_c = (temp_f - 32)*5/9) 

```

```{r}
summary(lm(cases ~ temp_c + rainfall_in, data = mosquitos_data))
```

seasonal trends of west nile cases and then seasonal trends of rainfall
and dp a regression model on them

### 2021 Monsoon 
Week 24 - 39 : June 15 through Sept. 30 was Monsoon season in 2021

```{r}
# import 2021 rainfall data
rainfall_2021 <- read_csv("data/2021-rainfall-maricopa.csv") %>% 
  clean_names() %>% 
  select(c(date, prcp)) %>% 
  mutate(week = week(ymd(date))) %>% 
  group_by(week) %>% 
  summarise(average_prcp = mean(prcp, na.rm = TRUE))

# import west nile cases for 2021 weeks
weekly_cases <- read_csv("data/az_2021_cases.csv")

# Join datasets

cases_2021 <- left_join(weekly_cases, rainfall_2021, by = "week")


p1 <- ggplot(cases_2021, aes(x = week, y = cases)) + 
  geom_line(color = "red") + labs(x = "Week", y = "Reported Cases Count") +
  theme_classic()
  
p2 <- ggplot(cases_2021, aes(x = week, y = average_prcp)) +
  geom_line(color = "deepskyblue3") + labs(x = "Week", y = "Average precipitation (in)") +
  theme_classic()

p1 / p2
```


### Granger Causality

- Does not prove direct causation 
- Measures the extent to which the past values of one variable provide valuable information for forecasting the other variable's behavior

Requirements:
- stationary
- constant mean
- constant variance
- no seasonal component

Steps: transform non-stationary data to stationary by differencing it - first or 
second

Yt is said to "Granger cause" Xt+1 provided Yt occurs before Xt+1 and contains
data for forecasting Xt+1

```{r}
# Check if average precipitation is stationary
adf.test(cases_2021$cases, alternative = "stationary")

# Check if average precipitation is stationary
adf.test(cases_2021$average_prcp, alternative = "stationary")
```


```{r}

# Calculate first differences for 'cases' and 'average_prcp'
cases_diff_1 <- diff(cases_2021$cases)
precipitation_diff_1 <- diff(cases_2021$average_prcp)

# Perform ADF test for first differences
adf.test(cases_diff_1, alternative = "stationary")
adf.test(precipitation_diff_1, alternative = "stationary")

# Calculate second difference for `cases` and `average_prcp`
cases_diff_2 <- diff(cases_diff_1)
precipitation_diff_2 <- diff(precipitation_diff_1)

# Perform ADF test for second differences
adf.test(cases_diff_2, alternative = "stationary")
adf.test(precipitation_diff_2, alternative = "stationary")
```

```{r}
# Conduct the granger test

#Assuming 'cases' and 'average_prcp' are your variables
data <- cbind(cases_diff_2, precipitation_diff_2)

# Determine lag order selection using information criteria
VARselect(data, lag.max = 10, type = "both")


grangertest(precipitation_diff_2, cases_diff_2, order = 4)

```

```{r, echo=TRUE}
# Cross Correlation Functions CCF for unstable
ccf_values <- ccf(cases_2021$cases, cases_2021$average_prcp)

ccf_values 

## Week 7 is where it peaks
```
```{r}
## CCF for stable

ccf(cases_diff_2, precipitation_diff_2)

```


Run a linear regression of reported case on created lagged precipitation

```{r}
# Create a lagged precipitation

# Run a lag for 7
lag7<- lag(cases_2021$average_prcp, 7)
#remove rows with NA values due to lag
lag7 <- na.omit(lag7)

length(lag7)

# remove first seven values of cases
truncated_cases <- cases_2021$cases[8:52]

summary(lm(truncated_cases ~ lag7))
  
# Run a lag for 2 - life cycle of a mosquito

lag2 <- lag(cases_2021$average_prcp,2)
lag2 <- na.omit(lag2)
truncated_cases2 <- cases_2021$cases[3:52]

summary(lm(truncated_cases2 ~ lag2))



```


```{r}

summary(lm(cases~average_prcp, data = cases_2021))
```